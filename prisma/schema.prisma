// This is your Prisma schema file
// Learn more about it: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  FOUNDER
  CUSTOMER
}

enum LeadStage {
  NEW
  CONTACTED
  QUALIFIED
  WON
  LOST
}

enum DealStatus {
  OPEN
  WON
  LOST
  REFUNDED
}

enum OrderStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model User {
  id                    String       @id @default(cuid())
  email                 String       @unique
  name                  String?
  emailVerified         DateTime?
  image                 String?
  role                  Role         @default(FOUNDER)
  rosterOptIn           Boolean      @default(false)
  orientationScheduledAt DateTime?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  
  Profile               Profile?
  Leads                 Lead[]
  Deals                 Deal[]
  Enrollments           Enrollment[]
  BootcampEnrollment   BootcampEnrollment?
  Orders                Order[]
  accounts              Account[]
  sessions              Session[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Profile {
  userId String @id
  city   String?
  bio    String?
  User   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model Lead {
  id        String    @id @default(cuid())
  ownerId   String
  name      String
  email     String?
  phone     String?
  notes     String?
  stage     LeadStage @default(NEW)
  nextAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Owner     User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  Deals     Deal[]

  @@index([ownerId])
  @@index([stage])
  @@map("leads")
}

model Deal {
  id          String     @id @default(cuid())
  ownerId     String
  leadId      String?
  amountCents Int
  product     String
  status      DealStatus @default(OPEN)
  closedAt    DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  Owner       User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  Lead        Lead?      @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@index([ownerId])
  @@index([status])
  @@map("deals")
}

model Enrollment {
  id        String   @id @default(cuid())
  userId    String
  program   String   // "Founding-50-bootcamp"
  week      Int      @default(1)
  progress  Json     // { week1: { lessons: [bool], quiz: bool, completedAt: ISO }, ... }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("enrollments")
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String
  priceCents  Int
  category    String   // "Merch", "BYOA", "Drops"
  imageUrl    String?
  inStock     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@map("products")
}

model Order {
  id              String      @id @default(cuid())
  userId          String?
  email           String
  status          OrderStatus @default(PENDING)
  totalCents      Int
  items           Json        // Array of { productId, name, quantity, priceCents }
  paymentProvider String      // "stripe" | "crypto"
  paymentId       String?     // Stripe session ID or crypto charge ID
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  User            User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([email])
  @@map("orders")
}

model BootcampEnrollment {
  id              String           @id @default(cuid())
  userId          String           @unique
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentWeek     Int              @default(1)
  startedAt       DateTime         @default(now())
  lastAccessedAt  DateTime         @updatedAt
  completed       Boolean          @default(false)
  completedAt     DateTime?
  notificationsEnabled Boolean     @default(true)

  weekProgress    WeekProgress[]
  reflections     Reflection[]
  businessCanvas  BusinessCanvas?

  @@map("bootcamp_enrollments")
}

model WeekProgress {
  id               String             @id @default(cuid())
  enrollmentId     String
  enrollment       BootcampEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  weekNumber       Int
  startedAt        DateTime           @default(now())
  completedAt      DateTime?
  lessonProgress   Json               @default("{}")
  exercisesComplete Json              @default("{}")
  timeSpent        Int                @default(0)

  @@unique([enrollmentId, weekNumber])
  @@map("week_progress")
}

model Reflection {
  id           String             @id @default(cuid())
  enrollmentId String
  enrollment   BootcampEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  weekNumber   Int
  content      String
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([enrollmentId, weekNumber])
  @@unique([enrollmentId, weekNumber])
  @@map("reflections")
}

model BusinessCanvas {
  id            String             @id @default(cuid())
  enrollmentId  String             @unique
  enrollment    BootcampEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  purpose       String
  product       String
  people        String
  process       String
  profit        String

  proper        String
  preparation   String
  prevents      String
  poor          String
  performance   String

  outcome       String
  role          String
  context       String

  brandName     String
  brandIdentity String
  targetMarket  String
  uniqueValue   String
  canvasSummary String
  launchTimeline String
  marketingStrategy String
  firstCustomerTarget String
  successMetrics String
  revenueShare   String
  supportLevel   String
  productionAccess String
  launchCommitments String
  supportRequests String

  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  publishedAt   DateTime?

  @@map("business_canvas")
}

